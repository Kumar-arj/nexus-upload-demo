def label = 'shopagent'
def mvn_version = 'M2'
podTemplate(label: label, yaml: '''
apiVersion: v1
kind: Pod
metadata:
  labels:
    app: build
  annotations:
    sidecar.istio.io/inject: "false"
spec:
  containers:
  - name: build
    image: kumararj/eos-jenkins-agent-base:latest
    command:
    - cat
    tty: true
    volumeMounts:
    - name: dockersock
      mountPath: /var/run/docker.sock
  volumes:
  - name: dockersock
    hostPath:
      path: /var/run/docker.sock
'''
) {
    node(label) {
        stage('CleanWorkspace') {
          cleanWs()
        }
        stage('Checkout SCM') {
          git credentialsId: 'git', url: 'https://github.com/Kumar-arj/nexus-upload-demo.git', branch: 'main'
        }

    stage('Publish to Nexus Repository Manager') {
        withEnv([ 'NEXUS_VERSION=nexus3','NEXUS_PROTOCOL=http','NEXUS_URL=nexus.k4m.in','NEXUS_REPOSITORY= sock-shop-release-local','NEXUS_REPO_ID=sock-shop-release-local','NEXUS_CREDENTIAL_ID=nexuslogin','ARTVERSION = ${env.BUILD_ID}']){
        script {
          pom = readMavenPom file: 'pom.xml'
          filesByGlob = findFiles(glob: "*.${pom.packaging}")
          echo "${filesByGlob[0].name} ${filesByGlob[0].path} ${filesByGlob[0].directory} ${filesByGlob[0].length} ${filesByGlob[0].lastModified}"
          artifactPath = filesByGlob[0].path
          artifactExists = fileExists artifactPath
          if (artifactExists) {
            echo "*** File: ${artifactPath}, group: ${pom.groupId}, packaging: ${pom.packaging}, version ${pom.version} ARTVERSION"
            nexusArtifactUploader(
                            nexusVersion: NEXUS_VERSION,
                            protocol: NEXUS_PROTOCOL,
                            nexusUrl: NEXUS_URL,
                            groupId: pom.groupId,
                            version: ARTVERSION,
                            repository: NEXUS_REPOSITORY,
                            credentialsId: NEXUS_CREDENTIAL_ID,
                            artifacts: [
                                [artifactId: pom.artifactId,
                                classifier: '',
                                file: artifactPath,
                                type: pom.packaging],
                                [artifactId: pom.artifactId,
                                classifier: '',
                                file: 'pom.xml',
                                type: 'pom']
                            ]
                        )
          }
            else {
            error "*** File: ${artifactPath}, could not be found"
            }
        }
        }

    // nexusVersion: 'nexus3',
    // protocol: 'http',
    // nexusUrl: 'nexus.k4m.in',
    // groupId: 'com.example',
    // version: version,
    // repository: 'RepositoryName',
    // credentialsId: 'CredentialsId',
    // artifacts: [
    //     [artifactId: projectName,
    //      classifier: '',
    //      file: 'my-service-' + version + '.jar',
    //      type: 'jar']
    // ]
    }
    // stage('Docker Build') {
    //       container('build') {
    //     stage('Build Image') {
    //       docker.withRegistry( 'https://registry.hub.docker.com', 'docker' ) {
    //         def customImage = docker.build('kumararj/eos-micro-services-admin:latest')
    //         customImage.push()
    //       }
    //     }
    //       }
    // }

    //     stage('Helm Chart') {
    //       container('build') {
    //         dir('charts') {
    //           withCredentials([usernamePassword(credentialsId: 'jfrog', usernameVariable: 'username', passwordVariable: 'password')]) {
    //           sh '/usr/local/bin/helm package micro-services-admin'
    //           sh '/usr/local/bin/helm push-artifactory micro-services-admin-1.0.tgz https://k4meos.jfrog.io/artifactory/eos-helm-local --username $username --password $password'
    //           }
    //         }
    //       }
    //     }
    }
}
